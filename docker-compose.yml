version: '3.8'

services:
  # ─── Backend + Frontend (Single Container) ───
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-}
    container_name: cloud_storage_app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL}

      # S3 Storage
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL}
      S3_REGION_NAME: ${S3_REGION_NAME:-auto}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}

      # OnlyOffice
      ONLYOFFICE_JWT_SECRET: ${ONLYOFFICE_JWT_SECRET:-supersecretjwtkeysupersecretjwtkey}
      ONLYOFFICE_URL: http://onlyoffice:80

      # Auth
      SECRET_KEY: ${SECRET_KEY:-supersecretauthkey}
      ALGORITHM: ${ALGORITHM:-RS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}

      # Admin defaults
      DEFAULT_ADMIN_USERNAME: ${DEFAULT_ADMIN_USERNAME:-admin}
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL:-admin@gmail.com}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD:-admin}

      # Razorpay
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-}

      # Frontend static files directory
      STATIC_DIR: /app/static
    volumes:
      - app_data:/app/data

  # ─── OnlyOffice Document Server ───
  onlyoffice:
    image: onlyoffice/documentserver
    container_name: cloud_storage_onlyoffice
    restart: unless-stopped
    ports:
      - "8080:80"
      - "4433:443"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET:-supersecretjwtkeysupersecretjwtkey}
      - JWT_HEADER=Authorization
      - JWT_IN_BODY=true
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_log:/var/log/onlyoffice
      - onlyoffice_lib:/var/lib/onlyoffice
      - onlyoffice_db:/var/lib/postgresql

volumes:
  app_data:
  onlyoffice_data:
  onlyoffice_log:
  onlyoffice_lib:
  onlyoffice_db:
